# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®åå‰
name: Rewrite File with Gemini

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èµ·å‹•ã™ã‚‹ãã£ã‹ã‘
on:
  # æ‰‹å‹•ã§å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
  workflow_dispatch:
    # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œæ™‚ã«å…¥åŠ›é …ç›®ã‚’è¨­ã‘ã‚‹
    inputs:
      file_path:
        description: 'æ›¸ãæ›ãˆã¦ã»ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ (ä¾‹: README.md)'
        required: true
        default: 'README.md'

# å®Ÿè¡Œã™ã‚‹å…·ä½“çš„ãªãŠä»•äº‹
jobs:
  rewrite-and-commit:
    # ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿ã‚’è¨±å¯ã™ã‚‹
    permissions:
      contents: write
    # ã“ã®ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹ä»®æƒ³ãƒã‚·ãƒ³ã®OS
    runs-on: ubuntu-latest
    # ã‚¸ãƒ§ãƒ–ã®ä¸­ã§å®Ÿè¡Œã™ã‚‹å€‹ã€…ã®æ‰‹é †
    steps:
      # æ‰‹é †1: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout Repository
        uses: actions/checkout@v4

      # æ‰‹é †2: æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’èª­ã¿è¾¼ã‚€
      - name: Read File Content
        id: file_reader
        run: |
          content=$(cat "${{ github.event.inputs.file_path }}")
          # è¤‡æ•°è¡Œã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ­£ã—ãæ‰±ã†ãŸã‚ã®å·¥å¤«
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # æ‰‹é †3: Gemini APIã‚’å‘¼ã³å‡ºã—ã¦æ–‡ç« ã‚’æ›¸ãæ›ãˆã‚‹
      - name: Rewrite Content with Gemini
        id: gemini_call
        run: |
          rewritten_text=$(curl -s -H 'Content-Type: application/json' -d '{
            "contents": [{
              "parts": [{
                "text": "ä»¥ä¸‹ã®æ–‡ç« ã‚’ã€ã‚ˆã‚Šæ˜ç¢ºã§ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªè¡¨ç¾ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚å…ƒã®æ„å›³ã¯å¤‰ãˆãªã„ã§ãã ã•ã„ã€‚\n\n---\n\n${{ steps.file_reader.outputs.content }}"
              }]
            }]
          }' 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${{ secrets.GEMINI_API_KEY }}' | jq -r '.candidates[0].content.parts[0].text')
          
          echo "rewritten_text<<EOF" >> $GITHUB_OUTPUT
          echo "$rewritten_text" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # æ‰‹é †4: æ–°ã—ã„å†…å®¹ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šæ›¸ãã—ã€ã‚³ãƒŸãƒƒãƒˆã—ã¦ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹
      - name: Commit and Push Changes
        run: |
          # Gitã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šæ›¸ã
          echo "${{ steps.gemini_call.outputs.rewritten_text }}" > "${{ github.event.inputs.file_path }}"
          
          # å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆã—ã¦ãƒ—ãƒƒã‚·ãƒ¥
          git add "${{ github.event.inputs.file_path }}"
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ“ Docs: ${{ github.event.inputs.file_path }} ã‚’GeminiãŒè‡ªå‹•æ›´æ–°"
            git push
          else
            echo "No changes to commit."
          fi
